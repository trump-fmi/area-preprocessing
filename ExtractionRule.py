import json

TARGET_PROJECTION = 4326


class ExtractionRule:
    def __init__(self, conditions):
        self.conditions = conditions

    def extract(self, database, source_tables):
        # Dict for all extracted geometries
        geometries_dict = {}

        # geometries_dict[-3222789] = json.loads('{"type": "Polygon", "coordinates": [[[6.04830317855428, 51.7189998647477], [6.05527482381127, 51.7223678731813], [6.0571270600956, 51.7232699766926], [6.06118519939161, 51.7252337744838], [6.06284465721596, 51.7260068945604], [6.0635454329691, 51.7264221058883], [6.06912504886183, 51.7309037750662], [6.06984253327925, 51.7314777852122], [6.07220824657998, 51.7333778030454], [6.07349265777321, 51.7342735115461], [6.07643931156818, 51.7363551029137], [6.07719236927086, 51.7369787772419], [6.07683106686359, 51.7370716795584], [6.07968573317346, 51.7392496000399], [6.08182561001176, 51.7409509873977], [6.08374225550196, 51.742471701793], [6.08410319858312, 51.7427744034553], [6.08721496272731, 51.7453161941767], [6.08931755948132, 51.7470001671838], [6.09102220256447, 51.7483336966705], [6.10035030847476, 51.7459315131889], [6.1008291105212, 51.746622687264], [6.10099682598474, 51.7468739701076], [6.10133746714048, 51.7473850966781], [6.10135444529935, 51.7474090677605], [6.10143277839213, 51.7475278662548], [6.1014661957207, 51.747578088558], [6.10156671720099, 51.7477293669191], [6.10169526611815, 51.7479230803455], [6.10213481178667, 51.7485819667378], [6.10618127298398, 51.7518339895163], [6.10569384711082, 51.7510565841101], [6.10374396395511, 51.7480434903685], [6.1064238181107, 51.7473798686445], [6.10474585499149, 51.7447941981882], [6.10532760396948, 51.7446479158649], [6.10734908285334, 51.7441224080071], [6.10752820692099, 51.7440774658998], [6.10948303081076, 51.7435873826668], [6.1101723979598, 51.7434145646239], [6.11558277125299, 51.7420238753826], [6.11854559472308, 51.746383805974], [6.11983431782967, 51.7483164000267], [6.1213665742098, 51.747924915697], [6.11980871584408, 51.7434170676257], [6.12379184581386, 51.7427300162381], [6.12575214942687, 51.7468219116254], [6.12592696158116, 51.7467738019703], [6.12591465466176, 51.7466342002536], [6.12625969756239, 51.7465509952005], [6.14020406605473, 51.7425994686185], [6.14069086310719, 51.742694473059], [6.14112995961807, 51.7429282009319], [6.1453592279757, 51.7418706866934], [6.14432562640979, 51.7404444049806], [6.14619061877116, 51.7397895719008], [6.14769044596952, 51.7407109079792], [6.14810070655978, 51.7411576905275], [6.15022378490227, 51.740627970145], [6.14910142978629, 51.7390424987875], [6.1547110494095, 51.7382803936071], [6.15791875362603, 51.7375060927061], [6.15905638010184, 51.737266885061], [6.15911243497557, 51.7374836739969], [6.15925832137771, 51.737750416975], [6.15937402438631, 51.7379238686028], [6.15943187589061, 51.7379841147949], [6.15950095633595, 51.7379979107722], [6.15956850964532, 51.7379797757367], [6.1596193542904, 51.7379109626675], [6.15792629947442, 51.7358574812851], [6.15679316457503, 51.7361040953495], [6.15698513455125, 51.736389204676], [6.15660900994179, 51.7364782140485], [6.15637257335901, 51.7361101035256], [6.15656373485147, 51.7360600909986], [6.15530789008427, 51.7344401892558], [6.1579790305816, 51.7336698838549], [6.15642530446619, 51.7316751847099], [6.15174445301522, 51.7328577832638], [6.11726828022059, 51.726615298602], [6.11337965301869, 51.7205038992503], [6.1084704498225, 51.7217611927436], [6.11264420229558, 51.7281218618434], [6.1075048507236, 51.7294325799834], [6.10230037129353, 51.7307548884292], [6.09810631689503, 51.7243258673517], [6.09278802091846, 51.7256666877434], [6.08826922554475, 51.7187847123787], [6.0938264733869, 51.7173814107572], [6.10004281515301, 51.7175912826685], [6.10249072430223, 51.7181129807284], [6.10536569253753, 51.7174385676961], [6.10381070878072, 51.7149397903196], [6.12171485104545, 51.7107637962631], [6.12265188371831, 51.710429597662], [6.12296117367064, 51.7102858759187], [6.12357337553676, 51.7101660888961], [6.12452100832998, 51.7101368657128], [6.12460275502084, 51.7101289058711], [6.12622250730963, 51.7094269870435], [6.1256475855278, 51.7094422946678], [6.12523957072575, 51.7094346130242], [6.12491815351709, 51.7093618043379], [6.12499846290349, 51.709235390813], [6.12514686458843, 51.7090975100485], [6.12533227686307, 51.7089673105879], [6.12558578143625, 51.7088332142148], [6.12598139948738, 51.7087067992126], [6.12616681176202, 51.7086494085776], [6.12801033438809, 51.7080766115383], [6.12799129010406, 51.7080221147269], [6.12820931122352, 51.7078321825277], [6.12792670123514, 51.7078595145551], [6.12756557849092, 51.7078641905011], [6.12753710189641, 51.7078064648006], [6.12702766729879, 51.7078900751934], [6.12701059930839, 51.707832405192], [6.12688142157053, 51.7078560075953], [6.12681916832134, 51.7079368902661], [6.12582158919833, 51.7078850095881], [6.12567462481785, 51.7078401984397], [6.12533982271146, 51.7078384727921], [6.12412251566995, 51.707875880364], [6.12389209779957, 51.7078625761865], [6.12368440730588, 51.7078125880702], [6.12343799942345, 51.7077318165096], [6.12293431404364, 51.7076492634836], [6.12151183179124, 51.7075809052335], [6.11999763154833, 51.7074670673645], [6.11727771253107, 51.7074465820843], [6.11649168665746, 51.7073615792058], [6.11566290097634, 51.7072986758595], [6.11446490771343, 51.7074486974126], [6.11387201962591, 51.7076961901379], [6.11326700428206, 51.7078385841242], [6.1128434486256, 51.7080747745682], [6.11192761619344, 51.7082727772497], [6.11029636546901, 51.7084196783136], [6.10915900848778, 51.7082959897648], [6.09706921189952, 51.7113439066258], [6.09701782826527, 51.7116576707596], [6.09627510118835, 51.712452786195], [6.09714080762766, 51.7126969675978], [6.09683295497979, 51.7132144920029], [6.09461258909204, 51.7127185080412], [6.0939251084051, 51.7126470961442], [6.0936920854204, 51.7126227726586], [6.09252481454021, 51.7127938716824], [6.09100378710114, 51.7128129073829], [6.08103841632829, 51.7120961687711], [6.07951963467743, 51.7122295875434], [6.07985003503893, 51.7129956942273], [6.07992181043013, 51.7131573853846], [6.07994956837241, 51.7132320803816], [6.07995019719311, 51.7133020998718], [6.07987078612199, 51.7134144759176], [6.07973451169339, 51.7134940128313], [6.07949151740904, 51.7136105628216], [6.07914988810649, 51.7136528636035], [6.07620925302392, 51.7136504146119], [6.0760039879815, 51.71359998762], [6.07577716337226, 51.7132792795411], [6.07564026012296, 51.713350913077], [6.07593975843868, 51.7136821958329], [6.07617942895649, 51.7140507116523], [6.07561798190391, 51.7141463883542], [6.07276511222461, 51.7141915828631], [6.0685504864061, 51.7144019704999], [6.06643899633078, 51.7145293714265], [6.05909850281812, 51.7169985631465], [6.05509291496624, 51.7183294163157], [6.0542758073838, 51.7185308802412], [6.05386976887538, 51.7186268813816], [6.05358239781599, 51.71870000907], [6.05350711899518, 51.7187208788224], [6.05342851640782, 51.7187202109905], [6.05325621953633, 51.7187623956879], [6.05212362362611, 51.7178460661939], [6.05161221273486, 51.7181069145064], [6.04750763053866, 51.7185764042856]], [[6.14325815835768, 51.7410690797483], [6.14405667081373, 51.7409400848382], [6.14426499012812, 51.74167817105], [6.14368629542209, 51.7418931032261], [6.14349854752771, 51.7418892095363], [6.1431251178641, 51.7419718113112], [6.14293835811653, 51.7420915697105], [6.14273830330276, 51.7420998020459], [6.14252486359125, 51.7421246102906], [6.14164460444434, 51.7423558936746], [6.14221808892172, 51.7418107794285], [6.1422714488496, 51.7416744998393], [6.1422714488496, 51.7415629727677], [6.14207139403582, 51.7415216993377], [6.14191131425219, 51.7416827878751], [6.14189801918599, 51.7418024914163], [6.1417579718332, 51.741794314651], [6.14154462195322, 51.7417281773593], [6.14139774740426, 51.741752985808], [6.14109771009937, 51.7418437645897], [6.1403908258023, 51.7413606658508], [6.1402640735157, 51.7412740023412], [6.13995065131308, 51.7412119805361], [6.13979057152945, 51.7412491936294], [6.13977062893014, 51.7413482615204], [6.13977727646324, 51.7414432685919], [6.13991732381603, 51.7415589121758], [6.14005737116883, 51.74165386318], [6.1403908258023, 51.7418314160162], [6.14056420065213, 51.7418892095363], [6.13967900077116, 51.7418874851879], [6.13953715678779, 51.7415299874015], [6.13945541009694, 51.7413326865715], [6.13956662152911, 51.7412338967711], [6.13897651821898, 51.7410117858061]], [[6.14832995662029, 51.7340933142251], [6.14857142376866, 51.7342454166112], [6.14877597015885, 51.7344734023308], [6.1489478178727, 51.7347090642523], [6.14897243171149, 51.7348534872399], [6.14891098694605, 51.7349574091966], [6.14891916161514, 51.7350384659317], [6.14904600373326, 51.7351297032632], [6.14911966558656, 51.7352740692743], [6.14906648532173, 51.7353450003825], [6.14810501847314, 51.7350409693975], [6.14796182701685, 51.7348534872399], [6.14792912834051, 51.7346963799309], [6.14788816516356, 51.7345215807178], [6.14776132304544, 51.734250367997]], [[6.14854052172288, 51.7373963911247], [6.14890496823365, 51.7373748624362], [6.14919431558667, 51.7374393928412], [6.14944314892037, 51.7375182755732], [6.14973815565967, 51.7376901704713], [6.14933903417894, 51.7378191746595], [6.14871991528512, 51.7379911796709], [6.14840739139778, 51.7380341808215], [6.1482743509042, 51.7378335826077]], [[6.14816439711342, 51.7359380913541], [6.14847108195142, 51.7361350819527], [6.14859262400936, 51.736464807023], [6.14870248796861, 51.7367765054299], [6.14835537894283, 51.736740679415], [6.14808336907479, 51.7367909137105], [6.14763205547605, 51.7368625100018], [6.14667741582362, 51.7353467806128]], [[6.13600821502566, 51.7396824903253], [6.13602555251064, 51.7397792809552], [6.13580573476062, 51.739775665217], [6.13564367868336, 51.739775665217], [6.13580573476062, 51.7401626031892], [6.13554531315975, 51.7402486013166], [6.13514026279814, 51.7395069872463]], [[6.15261788496597, 51.7350734031755], [6.15251691432804, 51.7348760741523]], [[6.1485541761152, 51.738833004586], [6.14772727689617, 51.7383992717357]], [[6.14542471515991, 51.739153865198]], [[6.13334210509392, 51.7419795986761]], [[6.13068273252681, 51.7409915938461]], [[6.12882528601384, 51.7413502640134]], [], []], "crs": {"type": "name", "properties": {"name": "EPSG:4326"}}}')

        # Iterate over all point tables
        for table in source_tables:

            print(f"Extracting from table \"{table}\"...")

            # Build query
            query = f"SELECT osm_id, ST_AsGEOJSON(ST_Transform(way, {TARGET_PROJECTION})) FROM {table} WHERE {self.conditions}"

            # Execute query
            result = database.queryForResult(query)

            # Iterate over all result rows
            for row in result:
                # Sanity check
                if len(row) < 1: continue

                id = row[0]
                geoJSON = row[1]

                geometry = json.loads(geoJSON)
                geometries_dict[id] = geometry

        # Return resulting list of geometries
        return geometries_dict
